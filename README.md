# Collateral Manager  
Collateral on the blockchain incurs massive opportunity costs by requiring capital that could be put to productive use elsewhere to be held in smart contracts until settlement. Lost capital held as on-chain collateral is a very real and rapidly growing challenge that drastically decreases liquidity across the network, disincentivizes staking funds in any smart contract, and cripples the growth potential of the blockchain economy as a whole.  
  
This smart contract system leverages price feeds, external keepers, and decentralized exchanges to allow users more control over their collateral. The collateral-requiring smart contract (referrred to as the admin contract) can implement any arbitrary logic, with the difference being that the funds serving as collateral are held in the Collateral Manager smart contract system rather than the admin contracct itself. The admin contract still has control of all logic regarding how and when these funds are payed out. Users can overcollateralize their positions according to risk parameters set by the admin contract, then submit an order from a decentralized exchange and BAM! They can hold their collateral in any asset that they choose and trade it as they please, provided the total value of the assets locked in the contract stays above the minimum required collateralization ratio (as set by the admin contract).  
  
I believe that the ability to more freely manage collateral on the blockchain has huge implications for the viability of on-chain secured debt, payment channels, and decentralized finance as a whole.

### Why is collateral on the blockchain unique?
In everday life, at least in most developed countries, collateral is able to live a "double life" by serving to secure debt or other guarantees while also being utilized for the property's originally intended purpose; i.e. a mortgage, which allows you to live in your house while it serves as collateral for your loan and as a (hopefully appreciating) asset. The downside to this is high counterparty risk in off-chain transactions. While smart contracts on the blockchain provide a greatly improved way to manage counterparty risk, they require full collateralization. This creates a unique problem, because capital that is locked away in smart contracts is lost liquidity. As the adoption of smart contracts increases, this problem will only get bigger. Additionally, losing access to your capital by relinquishing it to a smart contract is a tremendous disincentive for users, especially if the quote currency of the smart contract in question does not align with their ideal risk profile. If I want the safest possible investment I can find, but the only way to enter a smart contract is to leave it in an extremely volatile asset for the duration of the agreement, I am much less likely to do so. Alternatively, I might want to maximize my risk exposure and consider any collateral that must be held in a low-yield asset to be lost opportunity.  
  
This leveraging of personal property to serve a "double life" as collateral is arguably the single most important ingredient in the growth of a successful economy, an idea that is explored in Hernando de Soto's book, The Mystery of Capital. Off chain, the challenge is often finding a way to fix an asset's economic potential so that it can also serve as collateral. On the blockchain, the challenge is finding a way to allow collateral to also serve as an asset.  

## How does it work?
There are a few different players and components involved in the system in ways that are very similar to other blockchain projects, but may require some introduction if you haven't come across them before. While there are quite a few smart contracts within the Collateral Manager system itself, we will assume the system to be one monolithic entity for the time being. The Contract Collateral Manager system as a whole is also referred to as CCM, for the sanity of all involved.  
### Participants  

- **Admins** -> The *holders* of collateral. Admins are assumed to be (but aren't necessarily) smart contracts that the *users* presumably already have some purpose to interact with. Admin contracts can hold and distribute collateral by any arbitrary logic.  
- **Users**  -> Users are the *owners* of collateral. However, they are not in full control of this collateral. The collateral must remain in the Collateral Manager system above the minimum required amount in perpetuity *unless* the admin contract moves it or absolves the user of the obligation (closing the account).  
- **Oracles** -> Oracles, or price feeds, are sources of external information on the blockchain. Specifically, the oracles in the Collateral Manager system provide the current market exchange rate between token pairs.
- **Keepers** -> Keepers are external actors that are incentivized in some way to maintain the proper function of the system as a whole. *Admin* contracts can set the risk parameters for assets that their users can hold, and they can also set the rewards for keepers. Keepers watch the value of collateral held in the contract, waiting for the price of the held asset (`heldGem`) to fall relative to the quote asset (`owedGem`). As soon as it does, a keeper can `bite` the account, triggering a liquidation of collateral and earning a reward. In some cases, *admin* contracts may set this reward to zero if there is some mechanism already in place for rewarding keepers that trigger lquidations of collateral held by the contract.  
- **DEX's and trading counterparties** -> *Users* can submit orders that offer to buy their currently held assets from any decentralized exchange (DEX) with an on-chain settlement layer. Currently, the Collateral Manager system can only be a taker on exchanges, but in the future users may be able to place orders of their own on DEX's.  
  
### Basic System Flow  
1. The *user* sends some transaction to the *admin* contract that requires depositing of collateral.  
  
2. The *admin* contract performs any necessary logic, then opens an account in the Collateral Manager system. Just like requiring the transfer of an ERC20 token to it's own address to complete it's logic, the admin contract can require the successful opening of an account (which includes the transferring of the ERC20 from the user to the CCM contracts).  
  
**What does this "account" look like?**  
The account is made up of the address of the admin contract, which has ultimate control over the funds, the address of the user, the tokens and the account's balance in each token, and a few other details necessary for steps further along in the process. The **quote token**, or `owedGem`, is the only token that the admin contract ever deals with. The amount of collateral that must be held in the account is always denominated in this token. If the user holds another token in the account, price feeds are used to denominate the current value of the held assets in units of the quote token. The **held token** (`heldGem`), is any token that the user wishes to hold (and the admin has set risk parameters for) that is not the quote token. A user can keep a mix of both quote token and held token in the account, but the quote token is the 'ultimate source of truth' for the account.

3. The user, whose collateral is now held in the CCM contracts, now chooses to swap the currently held asset for a new one. For the sake of demonstration, we will say that the *admin* contract requires payout in WETH (wrapped Ether), making this the quote token. The user prefers less volatility, so she chooses to hold her collateral in DAI (a stablecoin). In order to make this change, she first has to overcollateralize her account.  
Becuase the value of a new held token could fluctuate relative to the value of the quote token, there is some minimum collateralization ratio (`biteLimit`) above which a user must be before they can hold a balance of the owed token below the owed amount. This ratio is set by the admin contract based on the risk parameters for each token pair. So, the user deposits a bit more WETH than required so that she can trade all of it for a new asset.  
The user then finds a 0x order from a relayer (note: only the 0x wrapper is currently implemented, but any DEX could be used). She submits this order to the CCM contracts, and the contracts execute the order. Now, she has no WETH in the account. All of her collateral is held in DAI.  

4. The price fluctuates, and the user can top up her collateral if needed to avoid liquidation.  
  
5. The contract can optionally include a callTime, which warns the user to pay up. Then, it pays everyone out and we're all happy.
